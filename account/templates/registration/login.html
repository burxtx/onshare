{% extends "account/base.html" %}
{% block title %}User Login{% endblock %}
{% block head %}User Login{% endblock %}
{% block content %}
  {% if form.has_errors %}
    <p>Your username and password didn't match.
      Please try again.</p>
  {% endif %}
  <form class="form-signin" method="post" action="" >
    {% csrf_token %}
    {{ form.username.errors }}
    <div class="form-group">
      <label class="control-label" for="id_username">Username:</label>
      <input class="form-control" id="{{ form.username.id_for_label }}" name="{{ form.username.html_name }}" type="text" maxlength="30" autofocus="" required="" placeholder="Email address">
    </div>
    <div class="form-group">
      {{ form.password.errors }}
      <label class="control-label" for="id_password">Password:</label>
      <input class="form-control" id="{{ form.password.id_for_label }}" name="{{ form.password.html_name }}" type="password" placeholder="Password">
    </div>
    <div class="form-group">
      <label class="checkbox-inline">
        <input type="checkbox" name="remember_me"> Remember me
      </label>
      | <a href="">Forget password?</a>
    </div>
    <div class="form-group">
      <button type="submit" class="btn btn-lg btn-primary btn-block" value="Login">Log in</button>
      <!--following line is required for redirect-->
      <!-- <input type="hidden" name="next" value="{{ next|escape }}" /> -->
      <input type="hidden" name="next" value="{{ next }}" />
    </div>
  </form>
{% endblock %}
{% block rcontent %}
  <div class="">
    >No Hashky account? 
    <a href="{% url account:register_page %}">Sign up now</a>
  </div>
  <div id="signin">
  </div>
  <script type="text/javascript">
  $(function (){
    WL.Event.subscribe("auth.login", onLogin);
    function onLogin(){
      var session = WL.getSession();
      if(!session.error){
        greetUser();}
    };
    function greetUser(){
      WL.api({
        path: "/me",
        method: "get"
      };).then(
          function (result) {
            document.getElementById("meName").innerText = "Welcome, " + result.name;
            getUserPicture ();
          });
    }; 
    function getUserPicture(){
      var session = WL.getSession();
      var LiveConnectAPIUrl = "https://apis.live.net/v5.0";
      document.getElementById("meImg").src = LiveConnectAPIUrl +
         "/me/picture?return_ssl_resources=true&access_token=" + session.access_token;
      document.getElementById("meImg").style.visibility = "visible";
    };
    var scopes = ["wl.signin", "wl.basic"];
    WL.init({
      client_id: ""0000000040125771,
      redirect_uri: "www.baidu.com",
      scope: "wl.signin", 
      response_type: "token"
    });
    WL.ui({
      name: "signin",
      element: "signin",
      scope: scopes
    });
  });
  </script>
{% endblock %}